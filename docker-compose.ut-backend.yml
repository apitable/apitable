version: '3'

services:
  test-mysql:
    container_name: test-mysql
    image: mysql:8.0.28-oracle
    networks:
      - apitable
    ports:
      - '3306:3306'
    environment:
      - MYSQL_DATABASE=apitable_test
      - MYSQL_USER=apitable
      - MYSQL_PASSWORD=password
      - MYSQL_ROOT_PASSWORD=password
    command: ['mysqld', '--sql_mode=IGNORE_SPACE,NO_ENGINE_SUBSTITUTION', '--character-set-server=utf8mb4', '--collation-server=utf8mb4_unicode_ci']
    healthcheck:
      test: "mysql $$MYSQL_DATABASE -u$$MYSQL_USER -p$$MYSQL_PASSWORD -e 'SELECT 1;'"
      interval: 30s
      timeout: 10s
      retries: 5

  test-init-db:
    container_name: test-init-db
    image: gradle:jdk8
    networks:
      - apitable
    working_dir: /data
    volumes:
      - ./init-db:/data
    environment:
      - DB_HOST=test-mysql
      - DB_PORT=3306
      - DB_NAME=apitable_test
      - DB_USERNAME=apitable
      - DB_PASSWORD=password
      - DATABASE_TABLE_PREFIX=apitable_
    entrypoint: ./gradlew update

  test-redis:
    container_name: test-redis
    image: redis:5.0.7-alpine
    networks:
      - apitable
    ports:
      - '6379:6379'
    healthcheck:
      test: ['CMD', 'redis-cli', '--raw', 'incr', 'ping']
      interval: 30s
      timeout: 10s
      retries: 5

  test-rabbitmq:
    container_name: test-rabbitmq
    image: rabbitmq:3-management
    networks:
      - apitable
    ports:
      - '5672:5672'
      - '15672:15672'
    environment:
      - RABBITMQ_DEFAULT_USER=apitable
      - RABBITMQ_DEFAULT_PASS=password
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 30s
      timeout: 10s
      retries: 5

  unit-test-backend:
    container_name: unit-test-backend
    image: amazoncorretto:8
    working_dir: /app
    networks:
      - apitable
    volumes:
      - ./backend-server:/app
    depends_on:
      - test-init-db
      - test-redis
      - test-rabbitmq
    environment:
      - JVM_OPTS="-Xms3200m -Xmx3200m"
      - MYSQL_HOST=test-mysql
      - MYSQL_PORT=3306
      - MYSQL_USERNAME=apitable
      - MYSQL_PASSWORD=password
      - MYSQL_DATABASE=apitable_test
      - REDIS_HOST=test-redis
      - REDIS_PORT=6379
      - REDIS_DB=3
      - REDIS_PASSWORD=
      - RABBITMQ_HOST=test-rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=apitable
      - RABBITMQ_PASSWORD=password
    entrypoint: ./gradlew testCodeCoverageReport --stacktrace

networks:
  apitable:
    driver: bridge