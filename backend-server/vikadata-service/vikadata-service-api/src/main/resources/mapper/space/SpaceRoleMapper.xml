<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.vikadata.api.modular.space.mapper.SpaceRoleMapper">
    <select id="selectSpaceRolePage" resultType="com.vikadata.api.model.vo.space.SpaceRoleVo">
        SELECT vsmrr.id,
               vsmrr.member_id,
               vu.avatar,
               vm.member_name,
               GROUP_CONCAT(DISTINCT vod.team_name ORDER BY vodmr.created_at DESC SEPARATOR ' | ') as team,
               vm.mobile,
               vm.is_active,
               GROUP_CONCAT(DISTINCT vsrg.group_code)                                              as tempResourceGroupCodes,
               vsmrr.created_at,
               IFNULL(vu.is_social_name_modified, 2) > 0  AS isNickNameModified,
               IFNULL(vm.is_social_name_modified, 2) > 0 AS isMemberNameModified
        FROM vika_space_member_role_rel vsmrr
        JOIN vika_unit_member vm on vsmrr.member_id = vm.id and vm.space_id = #{spaceId} and vm.is_deleted = 0
        LEFT JOIN vika_user vu on vm.user_id = vu.id
        JOIN vika_space_role_resource_rel vsrrr on vsmrr.role_code = vsrrr.role_code
        JOIN vika_space_resource vsr on vsrrr.resource_code = vsr.resource_code
        JOIN vika_space_resource_group vsrg on vsr.group_code = vsrg.group_code
        LEFT JOIN vika_unit_team_member_rel vodmr on vodmr.member_id = vsmrr.member_id
        LEFT JOIN vika_unit_team vod on vod.id = vodmr.team_id and vod.is_deleted = 0 and vod.parent_id != 0
        GROUP BY vsmrr.member_id
    </select>

    <delete id="deleteByRoleCode">
        DELETE
        FROM vika_space_role
        WHERE role_code = #{roleCode}
    </delete>

    <select id="selectResourceCodesById" resultType="java.lang.String">
        SELECT vsrrr.resource_code
        FROM vika_space_member_role_rel vsmrr
                 JOIN vika_space_role_resource_rel vsrrr on vsmrr.role_code = vsrrr.role_code
        WHERE vsmrr.id = #{id}
    </select>

    <delete id="batchDeleteByRoleCode">
        DELETE
        FROM vika_space_role
        WHERE role_code IN
        <foreach collection="roleCodes" index="index" item="iteam" open="(" close=")" separator=",">
            #{iteam}
        </foreach>
    </delete>
</mapper>
