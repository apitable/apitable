<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.vikadata.api.space.mapper.StaticsMapper">
    <select id="countSubAdminBySpaceId" resultType="java.lang.Long">
        SELECT COUNT(DISTINCT vsmrr.id)
        FROM vika_space_member_role_rel vsmrr
        JOIN vika_space_role_resource_rel vsrrr ON vsmrr.role_code = vsrrr.role_code
        WHERE vsmrr.space_id = #{spaceId}
    </select>

    <select id="countMemberBySpaceId" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM vika_unit_member
        WHERE space_id = #{spaceId}
          AND is_deleted = 0
    </select>

    <select id="countTeamBySpaceId" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM vika_unit_team
        WHERE space_id = #{spaceId}
        and is_deleted = 0
        and parent_id > 0
    </select>

    <select id="countDstBySpaceId" resultType="java.lang.Long">
        select COUNT(*)
        from vika_node
        where space_id = #{spaceId}
          and `type` in (2, 3, 4)
          and is_template = 0
          and is_rubbish = 0
    </select>

    <select id="countRecordsBySpaceId" resultType="java.lang.Long">
        SELECT SUM(JSON_LENGTH(vdm.meta_data -> '$.views[0].rows'))
        FROM vika_datasheet_meta vdm,
             vika_datasheet vd
        WHERE vdm.dst_id = vd.dst_id
          AND vdm.is_deleted = 0
          AND vd.is_deleted = 0
          AND vd.space_id = #{spaceId}
    </select>

    <select id="countApiUsageBySpaceId" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM vika_api_usage vau
        WHERE vau.space_id = #{spaceId} AND vau.id >= #{minId}
    </select>

    <select id="selectApiUsageMinIdByCreatedAt" resultType="java.lang.Long">
        SELECT MIN(id)
        FROM vika_api_usage
        WHERE
        <if test="minId != null">
            id > #{minId} AND
        </if>
        created_at >= #{startTime}
    </select>

    <select id="selectMaxId" resultType="java.lang.Long">
        SELECT MAX(id)
        FROM vika_api_usage
    </select>

    <select id="selectFileSizeBySpaceId" resultType="java.lang.Integer">
        SELECT file_size
        FROM vika_space_asset
        WHERE space_id = #{spaceId}
        AND cite > 0
        AND is_deleted = 0
        GROUP BY asset_id
    </select>

    <select id="countFieldControlBySpaceId" resultType="com.vikadata.api.space.model.ControlStaticsVO">
        SELECT
        SUM(IF(control_type = 0, 1, 0)) AS nodeRoleCount,
        SUM(IF(control_type = 1, 1, 0)) AS fieldRoleCount
        FROM vika_control
        WHERE space_id = #{spaceId}
        AND is_deleted = 0
    </select>

    <select id="selectNodeStaticsBySpaceId"
            resultType="com.vikadata.api.space.model.NodeStaticsVO">
        SELECT
            SUM(IF(`type` = 2, 1, 0)) AS fileCount,
            SUM(IF(`type` = 3, 1, 0)) AS formCount
        FROM vika_node
        WHERE space_id = #{spaceId} AND is_rubbish = 0 AND is_deleted = 0
    </select>

    <select id="selectNodeTypeStaticsBySpaceId"
            resultType="com.vikadata.api.space.model.NodeTypeStatics">
        SELECT
            type, COUNT(*) AS total
        FROM vika_node
        WHERE space_id = #{spaceId} AND is_rubbish = 0 AND is_deleted = 0
        GROUP BY type
    </select>

    <select id="selectDstViewStaticsBySpaceId" resultType="java.lang.String">
        SELECT JSON_EXTRACT(vdm.meta_data, '$.views[*].type') AS types
        FROM vika_datasheet_meta vdm, vika_datasheet vd
        WHERE vdm.dst_id = vd.dst_id AND vd.space_id = #{spaceId} AND vdm.is_deleted = 0 AND vd.is_deleted = 0;
    </select>

    <select id="selectMaxIdByTime" resultType="java.lang.Long">
        SELECT id
        FROM vika_api_usage
        WHERE DATE_FORMAT(created_at, '%Y-%m-%d') = #{time}
        ORDER BY id DESC
        LIMIT 1
    </select>

    <select id="countByIdGreaterThanAndSpaceId" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM vika_api_usage
        WHERE id > #{id}
          AND space_id = #{spaceId}
    </select>

    <select id="selectTotalSumBySpaceIdAndTimeBetween" resultType="java.lang.Long">
        SELECT SUM(total_count)
        FROM vika_api_statistics_daily
        WHERE space_id = #{spaceId}
          AND statistics_time BETWEEN #{startTime} AND #{endTime}
    </select>
</mapper>
