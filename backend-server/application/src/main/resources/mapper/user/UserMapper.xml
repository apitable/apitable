<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.vikadata.api.user.mapper.UserMapper">

    <select id="selectUserNameById" resultType="java.lang.String">
        SELECT nick_name
        FROM vika_user
        WHERE id = #{userId}
    </select>

    <select id="selectEmailById" resultType="java.lang.String">
        SELECT email
        FROM vika_user
        WHERE id = #{userId}
    </select>

    <select id="selectIdByMobile" resultType="java.lang.Long">
        SELECT id
        FROM vika_user
        WHERE mobile_phone = #{mobilePhone} AND is_deleted = 0
    </select>

    <select id="selectIdByEmail" resultType="java.lang.Long">
        SELECT id
        FROM vika_user
        WHERE email = #{email} AND is_deleted = 0
    </select>

    <select id="selectByMobile" resultType="com.vikadata.api.user.entity.UserEntity">
        SELECT *
        FROM vika_user
        WHERE mobile_phone = #{mobilePhone} AND is_deleted = 0
        LIMIT 0,1
    </select>

    <select id="selectByMobilePhoneIn" resultType="com.vikadata.api.user.entity.UserEntity">
        SELECT *
        FROM vika_user
        WHERE mobile_phone IN
        <foreach item="item" index="index" collection="mobilePhones" open="(" separator="," close=")">
            #{item}
        </foreach>
        AND is_deleted = 0
    </select>

    <select id="selectByEmail" resultType="com.vikadata.api.user.entity.UserEntity">
        SELECT * FROM vika_user WHERE email = #{email} AND is_deleted = 0
        LIMIT 0,1
    </select>

    <select id="selectCountByEmail" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM vika_user
        WHERE email = #{email} AND is_deleted = 0
    </select>

    <select id="selectByEmails" resultType="com.vikadata.api.user.entity.UserEntity">
        SELECT *
        FROM vika_user
        WHERE email IN
        <foreach item="item" index="index" collection="emails" open="(" separator="," close=")">
            #{item}
        </foreach>
        AND is_deleted = 0
    </select>

    <select id="selectIdByUuid" resultType="java.lang.Long">
        SELECT id from vika_user WHERE uuid = #{uuid}
    </select>

    <select id="selectIdByUuidList" resultType="java.lang.Long">
        SELECT id
        FROM vika_user
        WHERE uuid IN
        <foreach item="item" index="index" collection="uuidList" open="(" separator="," close=")">
            #{item}
        </foreach>
        AND is_deleted = 0
    </select>

    <select id="selectUuidById" resultType="java.lang.String">
        SELECT uuid
        FROM vika_user
        WHERE id = #{id}
        AND is_deleted = 0
    </select>

    <select id="selectByIds" resultType="com.vikadata.api.user.entity.UserEntity">
        SELECT vu.avatar, vu.email, vu.id, vu.nick_name, vu.uuid
        FROM vika_user vu
        WHERE vu.id IN
        <foreach collection="userIds" index="index" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        AND is_deleted = 0
    </select>

    <select id="selectByUuIds" resultType="com.vikadata.api.user.entity.UserEntity">
        SELECT *
        FROM vika_user vu
        WHERE vu.uuid IN
        <foreach collection="uuids" index="index" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        AND is_deleted = 0
    </select>

    <select id="selectAllUserIdByIgnoreDelete" resultType="java.lang.Long">
        SELECT id
        FROM vika_user
        WHERE created_at &lt;= NOW()
        <if test="!ignoreDelete">
        AND is_deleted = 0
        </if>
    </select>

    <update id="resetMobileByUserId">
        UPDATE vika_user
        SET code         = NULL,
            mobile_phone = NULL
        WHERE id = #{userId}
          AND is_deleted = 0
    </update>

    <update id="resetEmailByUserId">
        UPDATE vika_user
        SET email = NULL
        WHERE id = #{userId}
          AND is_deleted = 0
    </update>

    <update id="resetUserById">
        UPDATE vika_user
        SET email = null,
            code = null,
            mobile_phone = null,
            is_deleted = 1
        WHERE id = #{userId} AND is_deleted = 0
    </update>

    <select id="selectEmailByUserIds" resultType="java.lang.String">
        SELECT vu.email
        FROM vika_user vu
        WHERE vu.id IN
        <foreach item="item" index="index" collection="userIds" open="(" separator="," close=")">
            #{item}
        </foreach>
        AND vu.email IS NOT NULL
    </select>

    <select id="selectLocaleInEmailsWithDefaultLocale" resultType="com.vikadata.api.user.model.UserLangDTO">
        SELECT id, IFNULL(locale, #{defaultLocale}) as locale, email FROM vika_user
        WHERE email IN
        <foreach collection="emails" item="email" index="index" open="(" close=")" separator=",">
            #{email}
        </foreach>
        AND is_deleted = 0
    </select>

    <select id="selectLocaleByEmail" resultType="com.vikadata.api.user.model.UserLangDTO">
        SELECT id, locale, email FROM vika_user
        WHERE email = #{email}
        AND is_deleted = 0
    </select>

    <select id="selectLocaleByEmailWithDefaultLocale" resultType="com.vikadata.api.user.model.UserLangDTO">
        SELECT id, IFNULL(locale, #{defaultLocale}) as locale, email FROM vika_user
        WHERE email = #{email}
        AND is_deleted = 0
    </select>

    <select id="selectLocaleAndEmailByIds" resultType="com.vikadata.api.user.model.UserLangDTO">
        SELECT id, locale, email FROM vika_user
        WHERE id IN
        <foreach collection="ids" item="id" index="index" open="(" close=")" separator=",">
            #{id}
        </foreach>
        AND is_deleted = 0
    </select>

    <select id="selectPausedUsers" resultType="com.vikadata.api.user.model.UserInPausedDto">
        SELECT id as user_id FROM vika_user
        WHERE id IN
        <foreach item="item" index="index" collection="ids" open="(" separator="," close=")">
            #{item}
        </foreach>
        AND is_paused = 1 AND is_deleted = 0
    </select>

    <select id="selectInviteUserInfoByUserId" resultType="com.vikadata.api.space.model.InviteUserInfo">
        SELECT id as userId, nick_name as userName, avatar
        FROM vika_user
        WHERE id = #{userId}
          AND is_deleted = 0
    </select>
</mapper>
